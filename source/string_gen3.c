/*
 * This file is part of the PokeBoxDS project.
 * Copyright (C) 2019 Jennifer Berringer
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; even with the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <https://www.gnu.org/licenses/>.
 */
#include "string_gen3.h"
#include "asset_manager.h"

/* For more info on the games' character encoding, see:
 * https://bulbapedia.bulbagarden.net/wiki/Character_encoding_in_Generation_III
 */

// Look at gfx/font.png to see which glyph these character mappings correspond to.
/* My custom 1-byte charset is a superset of printable ascii with
 * Japanese Katakana and some other glyphs added. Note that there's not enough
 * space for Hiragana, so all Hiragana appears as the corresponding Katakana.
 */
static const uint8_t charmap_latin[] = {
' ',  0,    0,    0,    0x80, 0,    0x90, 0,    0,    0,    0,    0,    0,    0,    0,    0,
0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0x82, 0,    0,    0,    0,
0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    '&',  '+',  0,
0,    0,    0,    0,    0,    '=',  ';',  0,    0,    0,    0,    0,    0,    0,    0,    0,
0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
0,    0x09, 0x0a, 0x14, 0x15, 0x16, 0x17, 0,    0,    0,    0,    '%',  '(',  ')',  0,    0,
0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
0,    0,    0,    0,    0,    0,    0,    0,    0,    0x08, 0x09, 0x0b, 0x0a, 0,    0,    0,
0,    0,    0,    0,    '<',  '>',  0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
0,    '0',  '1',  '2',  '3',  '4',  '5',  '6',  '7',  '8',  '9',  '!',  '?',  '.',  '-',  0xf1,
0x07, 0x08, '"',  '`',  '\'', 0x0b, 0x0c, 0xf9, ',',  0xfd, '/',  'A',  'B',  'C',  'D',  'E',
'F',  'G',  'H',  'I',  'J',  'K',  'L',  'M',  'N',  'O',  'P',  'Q',  'R',  'S',  'T',  'U',
'V',  'W',  'X',  'Y',  'Z',  'a',  'b',  'c',  'd',  'e',  'f',  'g',  'h',  'i',  'j',  'k',
'l',  'm',  'n',  'o',  'p',  'q',  'r',  's',  't',  'u',  'v',  'w',  'x',  'y',  'z',  0x10,
':',  0x8e, 0x94, 0x9a, 0x84, 0x94, 0x9a, 0,    0,    0,    0,    0,    0,    0,    0,    0};

static const uint8_t charmap_jp[] = {
' ',  0xA0, 0xA1, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xAB, 0xAC, 0xAD, 0xAE,
0xAF, 0xB0, 0xB1, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9, 0xBA, 0xBB, 0xBC, 0xBD, 0xBE,
0xBF, 0xC0, 0xC1, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9, 0xCA, 0xCB, 0xCC, 0xCD, 0xCE,
0xCF, 0xD0, 0xD1, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8, 0xD9, 0xDA, 0xDB, 0xDC, 0xDD, 0xDE,
0xDF, 0xE0, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7, 0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE,
0xEF, 0xA0, 0xA1, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xAB, 0xAC, 0xAD, 0xAE,
0xAF, 0xB0, 0xB1, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9, 0xBA, 0xBB, 0xBC, 0xBD, 0xBE,
0xBF, 0xC0, 0xC1, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9, 0xCA, 0xCB, 0xCC, 0xCD, 0xCE,
0xCF, 0xD0, 0xD1, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8, 0xD9, 0xDA, 0xDB, 0xDC, 0xDD, 0xDE,
0xDF, 0xE0, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7, 0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE,
0xEF, '0',  '1',  '2',  '3',  '4',  '5',  '6',  '7',  '8',  '9',  '!',  '?',  0xF0, '-',  0xF1,
0x07, 0xF2, 0xF3, 0xF4, 0xF5, 0x0B, 0x0C, 0xF8, ',',  0xFD, '/',  'A',  'B',  'C',  'D',  'E',
'F',  'G',  'H',  'I',  'J',  'K',  'L',  'M',  'N',  'O',  'P',  'Q',  'R',  'S',  'T',  'U',
'V',  'W',  'X',  'Y',  'Z',  'a',  'b',  'c',  'd',  'e',  'f',  'g',  'h',  'i',  'j',  'k',
'l',  'm',  'n',  'o',  'p',  'q',  'r',  's',  't',  'u',  'v',  'w',  'x',  'y',  'z',  0x10,
':',  0x8e, 0x94, 0x9a, 0x84, 0x94, 0x9a, 0,    0,    0,    0,    0,    0,    0,    0,    0};

// This conversion is for arbitrary names that we don't know the language of.
// It's a "good enough" mapping that pretty much covers any valid nickname.
// There are just a few quirks:
//   * The Japanese brackets (bytes B1-B4 ingame) will appear as double/single quotes
//   * The French double angle quotes (bytes B1-B2 ingame) will appear as double ticks
//   * The Japanese period ("kuten" or "maru") will appear as the latin period
static const uint8_t charmap_mixed[] = {
' ',  0xA0, 0xA1, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xAB, 0xAC, 0xAD, 0xAE,
0xAF, 0xB0, 0xB1, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9, 0xBA, 0xBB, 0xBC, 0xBD, 0xBE,
0xBF, 0xC0, 0xC1, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9, 0xCA, 0xCB, 0xCC, 0xCD, 0xCE,
0xCF, 0xD0, 0xD1, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8, 0xD9, 0xDA, 0xDB, 0xDC, 0xDD, 0xDE,
0xDF, 0xE0, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7, 0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE,
0xEF, 0xA0, 0xA1, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xAB, 0xAC, 0xAD, 0xAE,
0xAF, 0xB0, 0xB1, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9, 0xBA, 0xBB, 0xBC, 0xBD, 0xBE,
0xBF, 0xC0, 0xC1, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9, 0xCA, 0xCB, 0xCC, 0xCD, 0xCE,
0xCF, 0xD0, 0xD1, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8, 0xD9, 0xDA, 0xDB, 0xDC, 0xDD, 0xDE,
0xDF, 0xE0, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7, 0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE,
0xEF, '0',  '1',  '2',  '3',  '4',  '5',  '6',  '7',  '8',  '9',  '!',  '?',  '.',  '-',  0xf1,
0x07, 0x08, '"',  '`',  '\'', 0x0b, 0x0c, 0xf9, ',',  0xfd, '/',  'A',  'B',  'C',  'D',  'E',
'F',  'G',  'H',  'I',  'J',  'K',  'L',  'M',  'N',  'O',  'P',  'Q',  'R',  'S',  'T',  'U',
'V',  'W',  'X',  'Y',  'Z',  'a',  'b',  'c',  'd',  'e',  'f',  'g',  'h',  'i',  'j',  'k',
'l',  'm',  'n',  'o',  'p',  'q',  'r',  's',  't',  'u',  'v',  'w',  'x',  'y',  'z',  0x10,
':',  0x8e, 0x94, 0x9a, 0x84, 0x94, 0x9a, 0,    0,    0,    0,    0,    0,    0,    0,    0};

int decode_gen3_string(char *out, const uint8_t *str, int len, uint16_t lang) {
	const uint8_t *map;
	lang &= 0xF;
	if (lang == LANG_JAPANESE)
		map = charmap_jp;
	else if (lang >= LANG_ENGLISH)
		map = charmap_latin;
	else
		map = charmap_mixed;

	int i;
	for (i = 0; i < len; i++) {
		uint8_t c = (uint8_t) str[i];
		if (c == 0xFF)
			break;
		// Only French has double angle quotes in place of double tickmark quotes
		if (lang == LANG_FRENCH && (c == 0xB1 || c == 0xB2))
			c = 0xFA + (c - 0xB1);
		else
			c = map[c];
		if (c)
			out[i] = c;
		else
			out[i] = '.';
	}
	out[i] = 0;
	return i;
}
